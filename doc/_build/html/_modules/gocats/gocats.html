
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>gocats.gocats &#8212; GOcats 1.1.7 documentation</title>
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>GOcats 1.1.7 documentation</span></a></h1>
        <h2 class="heading"><span>gocats.gocats</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for gocats.gocats</h1><div class="highlight"><pre>
<span></span><span class="c1"># !/usr/bin/python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The Gene Ontology Categories Suite (GOcats)</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">This module provides methods for the creation of directed acyclic concept subgraphs of Gene Ontology, along with methods</span>
<span class="sd">for evaluating those subgraphs.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">jsonpickle</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">ontologyparser</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">godag</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">subdag</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">_version</span>

<span class="n">jsonpickle</span><span class="o">.</span><span class="n">set_encoder_options</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="n">_version</span><span class="o">.</span><span class="n">__version__</span>


<div class="viewcode-block" id="json_format_graph"><a class="viewcode-back" href="../../api.html#gocats.gocats.json_format_graph">[docs]</a><span class="k">def</span> <span class="nf">json_format_graph</span><span class="p">(</span><span class="n">graph_object</span><span class="p">,</span> <span class="n">graph_identifier</span><span class="p">):</span>
    <span class="s2">&quot;Creates a dictionary representing the edges in the graph and formats it in such a way that it can be encoded into JSON for comparing the graph objects between versions of GOcats.&quot;</span>
    <span class="n">json_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">graph_object</span><span class="o">.</span><span class="n">edge_list</span><span class="p">:</span>
        <span class="n">json_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">graph_identifier</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">edge</span><span class="o">.</span><span class="n">json_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">json_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">json_dict</span></div>


<div class="viewcode-block" id="build_graph"><a class="viewcode-back" href="../../api.html#gocats.gocats.build_graph">[docs]</a><span class="k">def</span> <span class="nf">build_graph</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;**Not yet implemented**</span>

<span class="sd">    Try build_graph_interpreter to create a GO graph object to explore within a Python interpreter.&quot;&quot;&quot;</span>
    <span class="c1"># FIXME: JsonPickle is reaching max recursion depth because of the fact that objects point to one another.</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_namespace&#39;</span><span class="p">]:</span>
        <span class="n">supergraph_namespace</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_namespace&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">supergraph_namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--allowed_relationships&#39;</span><span class="p">]:</span>
        <span class="n">allowed_relationships</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--allowed_relationships&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">allowed_relationships</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">database</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;database_file&gt;&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">output_directory</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
    <span class="n">database_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;database_file&gt;&#39;</span><span class="p">])</span>
    <span class="n">graph_class</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go.obo&#39;</span><span class="p">:</span> <span class="n">godag</span><span class="o">.</span><span class="n">GoGraph</span><span class="p">(</span><span class="n">supergraph_namespace</span><span class="p">,</span> <span class="n">allowed_relationships</span><span class="p">)}</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">graph_class</span><span class="p">[</span><span class="n">database_name</span><span class="p">]</span>
    <span class="n">parsing_class</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go.obo&#39;</span><span class="p">:</span> <span class="n">ontologyparser</span><span class="o">.</span><span class="n">GoParser</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">graph</span><span class="p">)}</span>
    <span class="n">parsing_class</span><span class="p">[</span><span class="n">database_name</span><span class="p">]</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="build_graph_interpreter"><a class="viewcode-back" href="../../api.html#gocats.gocats.build_graph_interpreter">[docs]</a><span class="k">def</span> <span class="nf">build_graph_interpreter</span><span class="p">(</span><span class="n">database_file</span><span class="p">,</span> <span class="n">supergraph_namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_relationships</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relationship_directionality</span><span class="o">=</span><span class="s1">&#39;gocats&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a graph object of GO, which can be traversed and queried within a Python interpreter.</span>

<span class="sd">    :param file_handle database_file: Ontology database file.</span>
<span class="sd">    :param str supergraph_namespace: Optional - Filter graph to a sub-ontology namespace.</span>
<span class="sd">    :param list allowed_relationships: Optional - Filter graph to use only those relationships listed.</span>
<span class="sd">    :param relationship_directionality: Optional - Any string other than &#39;gocats&#39; will retain all original GO relationship directionalities. Defaults to reverseing has_part direction.</span>
<span class="sd">    :return: A Graph object of the ontology provided.</span>
<span class="sd">    :rtype: :py:obj:`class`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">database_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">godag</span><span class="o">.</span><span class="n">GoGraph</span><span class="p">(</span><span class="n">supergraph_namespace</span><span class="p">,</span> <span class="n">allowed_relationships</span><span class="p">)</span>
    <span class="n">go_parser</span> <span class="o">=</span> <span class="n">ontologyparser</span><span class="o">.</span><span class="n">GoParser</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">relationship_directionality</span><span class="o">=</span><span class="n">relationship_directionality</span><span class="p">)</span>
    <span class="n">go_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">graph</span></div>


<div class="viewcode-block" id="create_subgraphs"><a class="viewcode-back" href="../../api.html#gocats.gocats.create_subgraphs">[docs]</a><span class="k">def</span> <span class="nf">create_subgraphs</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a graph object of an ontology, processed into :class:`gocats.dag.OboGraph` or to an object that</span>
<span class="sd">    inherits from :class:`gocats.dag.OboGraph`, and then extracts subgraphs which represent concepts that are defined</span>
<span class="sd">    by a list of provided keywords. Each subgraph is processed into :class:`gocats.subdag.SubGraph`.</span>

<span class="sd">    :param database_file: Ontology database file.</span>
<span class="sd">    :param keyword_file: A CSV file with two columns: column 1 naming categories, and column 2 listing search strings (no quotation marks, separated by semicolons).</span>
<span class="sd">    :param output_directory: The directory where results are stored.</span>
<span class="sd">    :param --supergraph_namespace=&lt;None&gt;: OPTIONAL-Specify a supergraph sub-ontology to filter e.g. cellular_component.</span>
<span class="sd">    :param --subgraph_namespace=&lt;None&gt;: OPTIONAL-Specify a subgraph sub-ontology to filter e.g. cellular_component.</span>
<span class="sd">    :param --supergraph_relationships=[]: OPTIONAL-Specify a list of relationships to limit in the supergraph e.g. [is_a, part_of].</span>
<span class="sd">    :param --subgraph_relationships=[]: OPTIONAL-Specify a list of relationships to limit in subgraphs e.g. [is_a, part_of].</span>
<span class="sd">    :param --map_supersets: OPTIONAL-Allow subgraphs to subsume other subgraphs.</span>
<span class="sd">    :param --output_termlist: OPTIONAL-Create a translation of ontology terms to their names to improve interpretability of dev test results.</span>
<span class="sd">    :param --go-basic-scoping: OPTIONAL-Creates a GO graph similar to go-basic with only scoping-type relationships (is_a and part_of).</span>
<span class="sd">    :param --network_table_name=&lt;None&gt;: OPTIONAL-Make a specific name for the network table produced from the subgraphs (defaults to NetworkTable.csv)</span>
<span class="sd">    :return: None</span>
<span class="sd">    :rtype: :py:obj:`None`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_namespace&#39;</span><span class="p">]:</span>
        <span class="n">supergraph_namespace</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_namespace&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">supergraph_namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--subgraph_namespace&#39;</span><span class="p">]:</span>
        <span class="n">subgraph_namespace</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--subgraph_namespace&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subgraph_namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_relationships&#39;</span><span class="p">]:</span>
        <span class="n">supergraph_relationships</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_relationships&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">supergraph_relationships</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--subgraph_relationships&#39;</span><span class="p">]:</span>
        <span class="n">subgraph_relationships</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--subgraph_relationships&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subgraph_relationships</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--go-basic-scoping&#39;</span><span class="p">]:</span>
        <span class="n">supergraph_relationships</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;is_a&#39;</span><span class="p">,</span> <span class="s1">&#39;part_of&#39;</span><span class="p">]</span>
        <span class="n">subgraph_relationships</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;is_a&#39;</span><span class="p">,</span> <span class="s1">&#39;part_of&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--test&#39;</span><span class="p">]:</span>
        <span class="n">test</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Building the supergraph</span>
    <span class="n">database</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;database_file&gt;&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">output_directory</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
    <span class="n">database_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;database_file&gt;&#39;</span><span class="p">])</span>
    <span class="n">graph_class</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go.obo&#39;</span><span class="p">:</span> <span class="n">godag</span><span class="o">.</span><span class="n">GoGraph</span><span class="p">(</span><span class="n">supergraph_namespace</span><span class="p">,</span> <span class="n">supergraph_relationships</span><span class="p">)}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">supergraph</span> <span class="o">=</span> <span class="n">graph_class</span><span class="p">[</span><span class="n">database_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The provided ontology filename was not recognized. Please do not rename ontology files. The accepted list of file names are as follows: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">graph_class</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="n">parsing_class</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go.obo&#39;</span><span class="p">:</span> <span class="n">ontologyparser</span><span class="o">.</span><span class="n">GoParser</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">supergraph</span><span class="p">)}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsing_class</span><span class="p">[</span><span class="n">database_name</span><span class="p">]</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The provided ontology filename was not recognized. Please do not rename ontology files. The accepted list of file names are as follows: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">graph_class</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--output_termlist&#39;</span><span class="p">]:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">jsonpickle_save</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">supergraph</span><span class="o">.</span><span class="n">id_index</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;termlist&quot;</span><span class="p">))</span>

    <span class="n">id_translation</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">supergraph</span><span class="o">.</span><span class="n">id_index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">id_translation</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">jsonpickle_save</span><span class="p">(</span><span class="n">id_translation</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;id_translation&quot;</span><span class="p">))</span>

    <span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Building and collecting subgraphs</span>
    <span class="n">subgraph_collection</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;keyword_file&gt;&#39;</span><span class="p">],</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">subgraph_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">keyword_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyword</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">subgraph_collection</span><span class="p">[</span><span class="n">subgraph_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subdag</span><span class="o">.</span><span class="n">SubGraph</span><span class="o">.</span><span class="n">from_filtered_graph</span><span class="p">(</span><span class="n">supergraph</span><span class="p">,</span> <span class="n">subgraph_name</span><span class="p">,</span> <span class="n">keyword_list</span><span class="p">,</span> <span class="n">subgraph_namespace</span><span class="p">,</span> <span class="n">subgraph_relationships</span><span class="p">)</span>

    <span class="c1"># Handling superset mapping</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--map_supersets&#39;</span><span class="p">]:</span>
        <span class="n">category_subsets</span> <span class="o">=</span> <span class="n">find_category_subsets</span><span class="p">(</span><span class="n">subgraph_collection</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOTE: supersets were mapped.&quot;</span><span class="p">)</span>
        <span class="n">category_subsets</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">collection_id_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">collection_node_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">collection_content_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">subgraph_name</span><span class="p">,</span> <span class="n">subgraph</span> <span class="ow">in</span> <span class="n">subgraph_collection</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">category_node_id</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">root_id_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">collection_id_mapping</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">category_node_id</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">collection_id_mapping</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">category_node_id</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">category_node</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">root_node_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">collection_node_mapping</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">category_node</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">collection_node_mapping</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">category_node</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">rep_node</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">content_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">collection_content_mapping</span><span class="p">[</span><span class="n">rep_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>

    <span class="c1"># Remove root nodes that are subsets of existing root nodes from mapping</span>
    <span class="k">if</span> <span class="n">category_subsets</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">root_id_list</span> <span class="ow">in</span> <span class="n">collection_id_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">subset_id</span><span class="p">,</span> <span class="n">superset_ids</span> <span class="ow">in</span> <span class="n">category_subsets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">subset_id</span> <span class="ow">in</span> <span class="n">root_id_list</span><span class="p">:</span>
                    <span class="p">[</span><span class="n">root_id_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">superset_ids</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">root_id_list</span><span class="p">]</span>
    <span class="c1"># TODO: do the same for node_object_mapping</span>

    <span class="c1"># Save mapping files and create report</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">jsonpickle_save</span><span class="p">(</span><span class="n">collection_id_mapping</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;GC_id_mapping&quot;</span><span class="p">))</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">json_save</span><span class="p">(</span><span class="n">collection_id_mapping</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;GC_id_mapping&quot;</span><span class="p">))</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">jsonpickle_save</span><span class="p">(</span><span class="n">collection_content_mapping</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;GC_content_mapping&quot;</span><span class="p">))</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">json_save</span><span class="p">(</span><span class="n">collection_content_mapping</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;GC_content_mapping&quot;</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="s1">&#39;subgraph_report.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">report_file</span><span class="p">:</span>
        <span class="n">report_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;Subgraph data</span><span class="se">\n</span><span class="s1">Supergraph filter: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">Subgraph filter: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">GO terms in the supergraph: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">GO terms in subgraphs: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">Relationship prevalence: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">supergraph_namespace</span><span class="p">,</span> <span class="n">subgraph_namespace</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">supergraph</span><span class="o">.</span><span class="n">node_list</span><span class="p">)),</span>
                <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">collection_id_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="n">supergraph</span><span class="o">.</span><span class="n">relationship_count</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subgraph_name</span><span class="p">,</span> <span class="n">subgraph</span> <span class="ow">in</span> <span class="n">subgraph_collection</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">out_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                -------------------------</span>
<span class="s2">                </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Subgraph relationships: </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Seeded size: </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Representative node: </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Nodes added: </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Non-subgraph hits (orphans): </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Total nodes: </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subgraph_name</span><span class="p">,</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">relationship_count</span><span class="p">,</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">seeded_size</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">category_node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">node_list</span><span class="p">)</span> <span class="o">-</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">seeded_size</span><span class="p">,</span>
                           <span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">node_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">root_id_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                           <span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">root_id_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">report_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_string</span><span class="p">)</span>

    <span class="c1"># FIXME: cannot json save due to recursion of objects within objects...</span>
    <span class="c1"># tools.jsonpickle_save(collection_node_mapping, os.path.join(args[&#39;&lt;output_directory&gt;&#39;], &quot;GC_node_mapping&quot;))</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--network_table_name&#39;</span><span class="p">]:</span>
        <span class="n">network_table_name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--network_table_name&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">network_table_name</span> <span class="o">=</span> <span class="s2">&quot;Network_table.csv&quot;</span>

    <span class="c1"># Making a file for network visualization via Cytoscape 3.0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="n">network_table_name</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">network_table</span><span class="p">:</span>
        <span class="n">edgewriter</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">network_table</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">term_id</span><span class="p">,</span> <span class="n">root_id_list</span> <span class="ow">in</span> <span class="n">collection_id_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">root_id</span> <span class="ow">in</span> <span class="n">root_id_list</span><span class="p">:</span>
                <span class="n">edgewriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">term_id</span><span class="p">,</span> <span class="n">root_id</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
        <span class="n">json_graph_destination_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">__version__</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_graph_output.json&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_graph_destination_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">destfile</span><span class="p">:</span>
            <span class="n">destfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsonpickle</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">json_format_graph</span><span class="p">(</span><span class="n">supergraph</span><span class="p">,</span> <span class="s1">&#39;supergraph&#39;</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">subgraph_name</span><span class="p">,</span> <span class="n">subgraph</span> <span class="ow">in</span> <span class="n">subgraph_collection</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">destfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsonpickle</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">json_format_graph</span><span class="p">(</span><span class="n">subgraph</span><span class="p">,</span> <span class="n">subgraph_name</span><span class="p">)))</span>

        <span class="n">jsonpickle_supergraph_destination_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">__version__</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_supergraph_output.jsonpickle&#39;</span><span class="p">)</span>
        <span class="n">jsonpickle_clean_graph</span><span class="p">(</span><span class="n">supergraph</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonpickle_supergraph_destination_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">destfile</span><span class="p">:</span>
            <span class="n">destfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsonpickle</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">supergraph</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">subgraph_name</span><span class="p">,</span> <span class="n">subgraph</span> <span class="ow">in</span> <span class="n">subgraph_collection</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">jsonpickle_clean_graph</span><span class="p">(</span><span class="n">subgraph</span><span class="p">)</span>
            <span class="n">jsonpickle_subgraph_destination_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">__version__</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">subgraph_name</span><span class="o">+</span><span class="s1">&#39;_output.jsonpickle&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonpickle_subgraph_destination_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">destfile</span><span class="p">:</span>
                <span class="n">destfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsonpickle</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">subgraph</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">jsonpickle_clean_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">):</span>
    <span class="c1"># remove circular references from the nodes</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">node_list</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent_node_set</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">parent_node_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">node2</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">parent_node_set</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">child_node_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">node2</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">_descendants</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">_descendants</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">node2</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">_descendants</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">_ancestors</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">_ancestors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">node2</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">_ancestors</span><span class="p">])</span>

    <span class="c1"># remove sets or unneeded references from the graph</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="s2">&quot;super_graph&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">graph</span><span class="o">.</span><span class="n">super_graph</span><span class="p">:</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">super_graph</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">_orphans</span><span class="p">:</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">_orphans</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">node2</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">_orphans</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">_leaves</span><span class="p">:</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">_leaves</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">node2</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">_leaves</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">vocab</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">vocab_index</span><span class="p">:</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">vocab_index</span><span class="p">[</span><span class="n">vocab</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">node2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">node2</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">vocab_index</span><span class="p">[</span><span class="n">vocab</span><span class="p">]])</span>
    <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">used_relationship_set</span><span class="p">:</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">used_relationship_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">relationship</span> <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">used_relationship_set</span><span class="p">])</span>


<span class="c1"># TODO: the workaround for accessing the sole item in the set here is hacky, fix this later.</span>
<div class="viewcode-block" id="find_category_subsets"><a class="viewcode-back" href="../../api.html#gocats.gocats.find_category_subsets">[docs]</a><span class="k">def</span> <span class="nf">find_category_subsets</span><span class="p">(</span><span class="n">subgraph_collection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds subgraphs which are subsets of other subgraphs to remove redundancy, when specified.</span>

<span class="sd">    :param subgraph_collection: A dictionary of subgraph objects (keys: subgraph name, values: subgraph object).</span>
<span class="sd">    :return: A dictionary relating which subgraph objects are subsets of other subgraphs (keys: subset subgraph, values: superset subgraphs).</span>
<span class="sd">    :rtype: :py:obj:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_subset_of</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">subgraph</span> <span class="ow">in</span> <span class="n">subgraph_collection</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">next_subgraph</span> <span class="ow">in</span> <span class="n">subgraph_collection</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">category_node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_subgraph</span><span class="o">.</span><span class="n">category_node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">category_node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">))</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">next_subgraph</span><span class="o">.</span><span class="n">category_node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">))</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">category_node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">))</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">next_subgraph</span><span class="o">.</span><span class="n">root_id_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_subset_of</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">category_node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">))</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">next_subgraph</span><span class="o">.</span><span class="n">category_node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">))</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">is_subset_of</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">category_node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">))</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">next_subgraph</span><span class="o">.</span><span class="n">category_node</span><span class="o">.</span><span class="n">child_node_set</span><span class="p">))</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">is_subset_of</span></div>


<div class="viewcode-block" id="categorize_dataset"><a class="viewcode-back" href="../../api.html#gocats.gocats.categorize_dataset">[docs]</a><span class="k">def</span> <span class="nf">categorize_dataset</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads in a Gene Annotation File (GAF) and maps the annotations contained therein to the categories organized by</span>
<span class="sd">    GOcats or other methods. Outputs a mapped GAF and a list of unmapped genes in the specified output directory.</span>

<span class="sd">    :param dataset_file: A file containing gene annotations.</span>
<span class="sd">    :param term_mapping: A dictionary mapping category-defining ontology terms to their subgraph children terms. May be produced by GOcats or another method.</span>
<span class="sd">    :param output_directory: Specify the directory where the output file will be stored.</span>
<span class="sd">    :param mapped_dataset_filename: Specify the desired name of the mapped GAF.</span>
<span class="sd">    :param --dataset_type: Enter file type for dataset [GAF|TSV|CSV]. Defaults to GAF.</span>
<span class="sd">    :param --entity_col=&lt;0&gt;: If CSV or TSV file type, indicate which column the entity IDs are listed. Defaults to 0.</span>
<span class="sd">    :param --go_col: If CSV or TSV file type, indicate which column the GO IDs are listed. Defaults to 1.</span>
<span class="sd">    :param --retain_unmapped_annotations: If specified, annotations that are not mapped to a concept are copied into the mapped dataset output file with its original annotation.</span>
<span class="sd">    :return: None</span>
<span class="sd">    :rtype: :py:obj:`None`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--dataset_type&#39;</span><span class="p">]:</span>
        <span class="n">dataset_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--dataset_type&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataset_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--entity_col&#39;</span><span class="p">]:</span>
        <span class="n">entity_id_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;--entity_col&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">entity_id_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--go_col&#39;</span><span class="p">]:</span>
        <span class="n">go_id_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;--go_col&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">go_id_index</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">mapping_dict</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">jsonpickle_load</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;term_mapping&gt;&#39;</span><span class="p">])</span>
    <span class="n">output_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">])</span>
    <span class="n">mapped_dataset_filename</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;mapped_dataset_filename&gt;&#39;</span><span class="p">]</span>
    <span class="n">unmapped_entities</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dataset_type</span> <span class="o">==</span> <span class="s2">&quot;GAF&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dataset_type</span><span class="p">:</span>
        <span class="n">loaded_gaf_array</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">parse_gaf</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;dataset_file&gt;&#39;</span><span class="p">])</span>
        <span class="n">mapped_gaf_array</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">loaded_gaf_array</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mapping_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">mapped_terms</span> <span class="o">=</span> <span class="n">mapping_dict</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">mapped_terms</span><span class="p">:</span>
                    <span class="n">mapped_gaf_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">unmapped_entities</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;NO_GENE:&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">unmapped_entities</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">write_out_gaf</span><span class="p">(</span><span class="n">mapped_gaf_array</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">mapped_dataset_filename</span><span class="p">))</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">list_to_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">mapped_dataset_filename</span> <span class="o">+</span> <span class="s1">&#39;_unmappedEntities&#39;</span><span class="p">),</span> <span class="n">unmapped_entities</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">dataset_type</span> <span class="o">==</span> <span class="s2">&quot;CSV&quot;</span><span class="p">:</span>
        <span class="n">mapped_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;dataset_file&gt;&#39;</span><span class="p">]),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
            <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">csv_reader</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
                <span class="n">mapped_row</span> <span class="o">=</span> <span class="n">row</span>
                <span class="k">if</span> <span class="n">mapped_row</span><span class="p">[</span><span class="n">go_id_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mapping_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">concept_term</span> <span class="ow">in</span> <span class="n">mapping_dict</span><span class="p">[</span><span class="n">mapped_row</span><span class="p">[</span><span class="n">go_id_index</span><span class="p">]]:</span>
                        <span class="n">mapped_row</span><span class="p">[</span><span class="n">go_id_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">concept_term</span>
                        <span class="n">mapped_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapped_row</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">unmapped_entities</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mapped_row</span><span class="p">[</span><span class="n">entity_id_index</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--retain_unmapped_annotations&#39;</span><span class="p">]:</span>
                        <span class="n">mapped_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapped_row</span><span class="p">)</span>
            <span class="n">mapped_rows</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">mapped_dataset_filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_csv</span><span class="p">:</span>
            <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">mapped_rows</span><span class="p">:</span>
                <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">row</span><span class="p">])</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">list_to_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="s1">&#39;unmappedEntities&#39;</span><span class="p">),</span> <span class="n">unmapped_entities</span><span class="p">)</span></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Eugene Hinderer.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>